# 1.3 微处理器体系结构

微处理器，也就是通常所说的**中央处理器（CPU）**，是计算机系统中最重要、最核心的部件，CPU控制整个程序的执行，而程序是指令的序列，因此**CPU的根本任务就是执行指令**，在指令的执行过程中会对数据进行存储和处理。

## 1.3.1 单核处理器基本结构

按照冯·诺依曼体系结构，传统的单核CPU由控制器和运算器这两个主要部件组成。
CPU的逻辑结构主要由**控制器、运算器和存储单元**三部分组成。程序运行时，CPU从内存中一条一条地取出指令和相应的数据，按指令操作码地规定，对数据进行运算处理，直到程序执行完毕为止。  

- 控制器
控制器（控制单元） 是整个计算机系统的**指挥中心**。在控制器的指挥控制下，运算器、存储器和输入/输出设备等部件协同工作，构成一台完整的通用计算机。
- 运算器
运算器（运算单元）是计算机中用于实现数据加工处理等功能的部件，它接受控制器的命令，负责**完成对操作数据的加工处理**，其核心部件是**算术逻辑单元（ALU）**。
与控制器相比，运算器接受控制器的命令而进行操作，即**运算器所进行的全部操作都由控制器发出的控制信号来指挥**，所以它是**执行部件**。
- 存储单元
存储单元包括**CPU片内的高速缓冲和寄存器组**，是CPU中暂时存放数据的地方，里面保存着那些**等待处理的数据或已经处理过的数据**。

## 1.3.2 多核处理器基本结构

- 目前，通用处理器芯片基本上都采用了多核处理器（CMP）的架构。
- 按计算内核的对等与否，CMP可分为**同构多核**和**异构多核**：**计算内核相同、地位对等的称为同构多核**，Inter和AMD主推的多核处理器，大都是同构的多核处理器；**计算内核不同，地位不对等的称为异构多核**，异构多核多采用“主处理核+协处理核”的设计。

CMP的各CPU核心执行的程序之间需要进行数据的共享与同步，因此其硬件结构必须支持核间通信。 高效的通信机制是CMP高性能的重要保障，目前比较主流的片上高效通信机制有两种：**一种是基于总线共享的Cache结构，另一种是基于片上的互联结构。**

- 总线共享Cache结构是指**每个CPU内核拥有共享的二级或三级Cache，用于保存比较常用的数据，并通过连接核心的总线进行通信**。这种系统的优点是结构简单，通信速度高，缺点是基于总线的结构可扩展性较差。
- 基于片上的互联结构是指**每个CPU互信具有独立的处理单元和Cache，各个核心通过交叉开关或片上网络等方式连接在一起。各个CPU核心间通过消息通信**。这种结构的优点是可扩展性好，数据带宽有保证，缺点是硬件结构复杂，且软件改动较大。

## 1.3.3 指令的执行

计算机运行程序的过程就是**指令的执行过程**，CPU从存放程序的主存储器里去除一条指令，译码并执行这条指令，保存执行结果，紧接着又去取下一条指令、译码和执行，如此周而复始，使得计算机能够自动地工作。

不同型号的CPU指令执行过程可能有所不同，但基本上都会包含以下5个阶段:

1. 取指令（Instruction Fetch，IF）阶段：这一步将一条指令从主存储器中取到指令寄存器中。程序计数器PC中的数值用来指示当前指令在主存中的位置。当一条指令被取出后，PC中的数值将根据指令字长度而自动递增。
2. 指令译码（Instruction Decode，ID）阶段：取出指令后，计算机立即进入指令译码阶段。在指令译码阶段，指令译码器按照预定的指令格式，对取回的指令进行拆分和解释，识别出不同的指令类别以及各种获取操作数的方法。
3. 执行指令（Execute，EX）阶段：在取指令和指令译码阶段之后，进入执行指令阶段。此阶段的任务是完成指令所规定的各种操作，具体实现指令的功能。为此，CPU的不同部分被连接起来，以执行所需的操作。
4. 访存取数（Memory, MEM）阶段:根据指令需要，有可能要访问主存，读取操作数，这样就进入了访存取数阶段。此阶段的任务是根据指令地址码，得到操作数在主存中的地址，并从主存中读取该操作数用于运算。
5. 结果写回（Write-Back，WB）阶段，作为最后一个阶段，结果写回阶段把运行结果数据“写回”某种存储形式中。结果经常被写刀CPU的内部寄存器中，以便被后续的指令快速地访问；在有些情况下，结果数据也可被写入相对较慢、但较廉价且容量较大的主存。许多指令还会改变程序状态字寄存器中标志位的状态，这些标志位标识着不同的操作结果，可被用来影响程序的动作。

上述5个阶段形成了一个指令周期。**CPU取出并执行一条指令所需全部时间称为指令周期，即CPU完成一条指令的时间**。指令周期通常用**若干个CPU周期**来表示。**CPU周期又称为机器周期**，是指**CPU从内存读取一条指令字的最短时间**。一个CPU周期包含若干个时钟周期。**时钟周期定义为CPU时钟频率的倒数**，是计算机中**最基本、最小的**时间单位。

现代微处理器在指令执行过程中采用了许多技术来提高处理器的运行效率，其中比较基本和关键的技术有：**流水线、分支预测、乱序执行、超标量、超长指令字和向量指令等**。

- 流水线是处理器微架构最基本的一个要素，它承载并决定了处理器其他微架构的细节。 从原理上来看，如果能够将一个任务细分成若干个子任务，每个子任务由各自独立的功能部件进行处理，若干个任务的处理过程就可以采用流水方式进行。计算机的指令执行过程正好具有这样的特点，**一条指令的执行可分为多个阶段，每个阶段所需要的硬件资源不一样，因此可以采用流水线技术，同时执行多条指令的不同阶段**。
- 时空图是描述和分析流水线工作过程的重要工具。在指令流水线的时空图中，**纵坐标表示指令序列，横坐标表示周期时间**。
- 对标量流水计算机而言，上一条指令与下一条指令的5个子过程在时间上可以重叠执行，**当流水线满载时，每一个时钟周期就可以输出一个结果**。
