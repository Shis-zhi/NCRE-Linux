# 1.2 计算机体系结构的基本概念

## 1.2.1 摩尔定律

- 每过18个月，芯片上可以集成的晶体管数量将增加一倍。

## 1.2.2 计算机系统的层次结构

|计算机系统的结构层次|
|---|
|第六层：**应用程序层**|
|第五层：**高级语言层**|
|第四层：**汇编语言层**|
|第三层：**操作系统层**|
|第二层：**传统机器层**|
|第一层：**微体系结构层**|
|第零层：**数字逻辑层**|

- 第零层到第二层主要由硬件实现，第三层至第六层主要由软件实现。
- 计算机中的许多功能可以由硬件实现，也可以由软件实现，即从用户的角度来看它们在功能上是等价的，这称为软件和硬件逻辑功能的等价性，因此，**计算机系统的软硬件没有一个明确的分界面**。
- 不过在设计计算机系统的时候，首先需要明确软硬件的功能分配及其界面，**指令集**就充当了这一分界面的角色。
  
## 1.2.3 指令集

- 指令集是一个计算机系统支持的**所有机器指令**的集合，它常常被看作软硬件之间分界面。
- 计算机系统工作的基本过程是：程序员编写的软件经编译器翻译成可执行程序，（也就是一个机器指令的序列），然后由底层硬件一条条读取这些指令来执行。
- 由上述过程可见，软件最终体现为指令集中的各种指令。指令集对上层软件来说，就是加减乘除等基本操作的一个集合，这些基本操作堆砌形成了更复杂的软件功能，如队列、堆栈、函数调用等。对下层硬件来说，指令集提供了一个计算机系统实现的目标蓝图，底层硬件可以看作对指令集的实现。

指令集因其系统性和复杂性，也被称为**指令集体系结构**(ISA)。
下面介绍指令格式，寻址方式和常用指令的功能分类，然后介绍ISA的两大阵营CISC和RISC，以及几种主要的ISA(X86、ARM、MIPS)。

### 1>指令格式

- 计算机中最普通的指令格式：**操作码+操作数(地址)**
- **操作码字段**指明操作类型，如加法、减法、转移等操作，**操作数字段**指明具体的操作数或操作数的来源(地址)。
- **不同功能的指令需要的操作数可能会不一样多**，如加法指令需要三个操作数，指明两个加数和结果的保存位置，而跳转指令只需要一个操作数，指明跳转的目标地址，根据**操作数的数量不同**，可以将指令格式分为：**零地址指令**、**一地址指令**、**二地址指令**、**三地址指令**和**多地址指令**。
- 指令的操作码以及操作数在计算机中用**二进制数据**来表示，这种表示方式非常麻烦，因此通常用一些**比较容易记忆的文字符号**来表示指令中的操作数和操作码，这种符号称为**助记符**。
- 助记符通常是英文的缩写，并且提示了每条指令的意义，因此书写和阅读起来比较方便。例如：ADD（加法），SUB（减法），MOV（传送）等。
- 汇编语言作为直接面向CPU最底层的低级语言，就是采用助记符代替机器指令的操作码，用地址符号或标号代替指令或操作数的地址。例如下面几条汇编指令，先将寄存器AX的值设为0010H，寄存器BX的值设为0020H，然后将AX和BX中的内容相加，结果保存到AX中。
MOV AX，0010H
MOV BX，0020H
ADD AX，BX

### 2>寻址方式

- 寻址方式指的是**如何确定指令中操作数的地址及下一条指令的地址**。
- 由于采用了程序计数器（PC），因此对非转移指令，寻找下一条指令的地址只需要对PC递增即可；对转移指令，下一条指令的地址码需要由本条指令的操作数给出。通常把寻址笼统地理解为**寻找操作数的地址(存储单元位置)**。
- 按指令的寻址空间来分，寻址方式可以分为**立即数寻址**，**寄存器寻址**，**主存寻址**和**堆栈寻址**4种。

### 3>指令的功能分类

- 从指令的操作码功能来考虑，通用计算机的指令系统中常见的指令类型包括：**数据传送指令**、**算术运算指令**、**逻辑运算指令**、**程序控制指令**、**输入输出指令**、**处理器控制和调试指令**。
- 数据传送指令包括**取数指令LOAD**、**存数指令STORE**、**存储器或者寄存器之间数据传送指令MOV**等。
- 算术运算指令包括**加法ADD**、**减法SUB**、**乘法MUL**、**除法DIV**等。
- 逻辑运算指令包括**逻辑与AND**、**逻辑或OR**、**逻辑非NOT**等。
- 程序控制指令包括**转移指令JUMP（包括无条件转移和条件转移）**、**程序调用和返回指令（CALL、RETURN）**、**循环控制指令**等。
- 输入输出指令是**主机与外围设备进行信息交换**的一类指令，用于**检测外设的工作状态**、**读写外设的数据**等。
- 处理器控制类指令包括**空操作指令NOP**、**复位中断指令CLI**、**复位进位标志指令CLC**等。

### 4>CISC和RISC

- 根据指令系统复杂程度的不同,ISA可分为CISC和RISC两大阵营。CISC是指复杂指令系统计算机（Complex Instrument Set Computer）；RISC是指（Reduced Instrument Set Computer）。
- CISC结构追求的目标是**强化指令功能**，**减少程序的指令条数**，以达到**提高性能**的目的。早期的计算机系统几乎全都是CISC架构。
- RISC体系结构的基本思想是**尽量简化计算机指令功能**，只保留那些功能简单、能在一个节拍内执行完成的指令、而把较复杂的功能用一段程序来实现。
- RISC通过**减少指令种类**，**规范指令格式**和**简化寻址方式**等方法，方便处理器内部的并行处理，提高超大规模集成电路（VLSI）器件的使用效率，从而大幅度地提高处理器的性能。
- 目前，CISC占据了桌面和服务器领域的大部分市场，RISC占据了移动端和物联网领域大部分市场，但他们只是代表了ISA设计的两个主要方向。

### 5>常用ISA

- (1) X86
X86实际上是一个指令集家族，按照微处理器体系结构的不同，X86指令集家族又可分为**X86-32(IA-32)**和**X86-64(AMD64)**。  
X86指令集是**目前世界上最流行的指令集**，也被认为是**现存唯一的CISC指令集**。
- (2) ARM
ARM属于RISC指令集架构，得益于RISC架构简介的优势，可以很容易地实现低功耗需求，降低设计难度和散热性需求，同时具备良好的扩展性以满足众多需求。
ARM如今占据了手机等移动设备的大部分市场份额，并且发展势头良好。
- (3) MIPS
MIPS是一种典型的RISC指令集架构，如今，除了ARM以外，最流行的RISC架构就是MIPS。
与ARM架构相比，MIPS指令比ARM稍微多一些，执行部分运算更为灵活；MIPS
的内核寄存器比ARM多一倍，在同样的性能下MIPS的功耗会比ARM更低，在同样的功耗下性能比ARM更高；在架构授权方面MIPS更为开放，允许授权商自行更改设计。
然而，MIPS学院派的发展风格导致其商业进程远远滞后于ARM，围绕MIPS的软件生态比ARM差很多。

## 1.2.4 存储系统

- 计算机系统的本质属性是**时间**和**空间**，也就是**计算**和**存储**，可见存储器在计算机系统中占有十分重要的地位。计算机系统中存储器的任务主要是**存储程序（指令）和数据**。
- 现代通用计算机中的存储系统通常是如下的层次结构：

||速度|容量|价格|
|---|---|---|---|
|寄存器组|非常快|非常小|非常贵|
|高速缓冲存储器|非常快|小|非常贵|
|主存储器|快|大|便宜|
|辅助存储器|慢|非常大|非常便宜|
|脱机存储器|非常慢|巨大|最便宜|

1. 寄存器组为CPU的一部分，是汇编程序员可编程的空间，也是高级语言中编译器可支配的空间。
2. 高速缓冲存储器（Cache），它置于主存储器与CPU之间，存放那些运行程序近期将要用到的指令与数据。
3. 主存储器是**计算机的主要部件**，是**存储系统的核心**。CPU的指令可以直接访问，也是用户能够直接用到的编程空间。
4. 辅助存储器由**软盘**，**硬盘**组成。
5. 脱机存储器指**磁带机**，**光盘**等。

- 程序往往重复使用它刚刚使用过的数据和指令，这种规律称为**程序访问的局部性**。程序访问的局部性包含**时间局部性**和**空间局部性**两方面。
- 时间局部性是指最近访问过的内容很可能在短期内被再次访问。比如循环。
- 空间局部性是指某个存储单元被访问，短时间内**其附近的存储单元**也会被访问。

“Cache-主存-辅存”是存储体系里最重要的三级层次，通常将其分为 **“Cache-主存”** 和 **“主存-辅存”**两个两级存储系统来讨论。“主存-辅存”两级存储系统也被称为**虚拟存储系统**。

1. Cache 和主存储器
    “Cache-主存”层次的理论依据是程序局部性，基本做法是：把正在执行的指令地址附近的一部分指令和数据从主存调入Cache供CPU连续访问；当访问不到（不命中）是，再从主存调入Cache。
    因为Cache容量小，当它存满数据之后，CPU再进行访问时要将Cache中已经运行过的、近期不用或少用的信息替换出去，将新近需要的指令和数据补充进来。为此，就需要按一定原则选择应该替换的内容与主存进行数据交换。
    为了便于进行地址的映射和变换以及替换控制，需要把Cache和主存划分成大小相同的**块**。块是Cache与主存之间的信息传输单位，每块由若干个字或字节（Byte）组成。  由于Cache本身容量很小，因此划分成的Cache块也很小。**Cache块也称为Cache行**，是Cache存取的基本单位。
    “Cache-主存”层次主要涉及以下几个关键问题：
    （1） 地址映射
    Cache与主存储器间最基本的地址映射方式有三种：全相联映射、直接映射和组相联映射。
    - 全相联映射是指主存和Cache分成相同大小的数据块，主存的第i块可以放入Cache中的任意一个位置。
    - 直接映射是最简单的一种映射方式，主存中的每一个块只能被放置到Cache中唯一的一个位置。
    - 组相联映射是全相联映射和直接映射相结合的一种方式，是目前应用最广泛的地址映射方式。主存和Cache都分组，主存中一个组内的块数与Cache的分组数量相同，**组间采用直接映射**，**组内采用全相联映射**。若Cache每组中的块数为n，则称之为n路组相联映射，可以看出，直接映射为1路组相联映射，而全相联映射为M路组相联映射（M为Cache的总块数）。

    （2） 替换策略
    在采用全相联映射和组相联映射的系统中，当主存向Cache传送一个新块而Cache已满时，就需要使用替换算法将Cache中的某一块换出。常用的替换算法有**随机法（RAND）、先进先出法（FIFO）和最近最少使用法（LRU）**。
    - 随机法：随机地确定替换的存储块。
    - 先进先出法：在候选块中选择最早送入Cache的那一行进行替换。
    - 最近最少使用法：依旧各块使用的情况，总是选择那个最近最少使用的块来替换。

    （3） 数据一致性
    **一致性**：**同一份数据**在**不同存储位置**的多个拷贝应保持一致。在现代多核处理器中，Cache的一致性体现在两个方面：一是**Cache与主存之间**的数据一致性，二是**各个处理器内核私有的Cache之间**的数据一致性。<br>  
    Cache与主存之间的数据一致性通过Cache特定的写操作方式来保证，有以下两种常用的Cache写方式：

    - 写直达(Write Through)：每次CPU修改了Cache中的数据，立即更新到主存。
    - 写回(Write Back)：每次CPU修改了Cache中的数据，不会立即更新到主存，而是等到某一个合适的时机才会被更新到主存中。

    在多核处理器中，处理器内核之间的缓存一致性通过**缓存一致性协议**来维护，MESI是最为经典的缓存一致性协议。MESI协议将Cache Line的状态分成**修改（Modify）**、**独占（Exclusive）**、**共享（Shared）** 和 **失效（Invalid）**。

    - 修改：当前CPU Cache拥有最新数据，其他CPU拥有实效数据，虽然**当前CPU中的数据和主存是不一致的，但是以当前CPU的数据为准**。
    - 独占：只有当前CPU中有某数据，其他CPU中没有该数据，**当前CPU的数据和主存中的数据是一样的**。
    - 共享：当前CPU和其他CPU中有共同数据，并且**和主存中的数据一致**。
    - 失效：当前CPU中的数据失效，数据应该从主存中获取，其他CPU中**可能**有数据也可能无数据，**当前CPU中的数据和主存被认为是不一致的**。
<br>
2. 虚拟存储系统

   - 虚拟存储系统的提出是为了**满足应用程序对高速大容量主存的需求**。
   - **程序的指令和数据都采用虚拟存储空间地址**，这样每一个应用程序来说，就好像拥有一连续，完整且足够大的内存，但这个内存实际上是不存在的，是一个虚拟的存储器。
   - 程序在运行前保存在外部辅助存储器上，通常也就是保存在磁盘上，在运行时将程序的指令和数据都装入内存。在这一过程中，内存（主存）和磁盘（辅存）的关系类似于前面介绍的Cache和主存的关系，从“Cache-主存”层次的存储管理可知，“主存-辅存”层次的存储管理也需要类似的一些技术来解决地址映射、换入换出等问题。我们把“主存-辅存”这个层次的存储管理技术称为**虚拟存储管理技术**。
