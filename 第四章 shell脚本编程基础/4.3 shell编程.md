# 4.3 shell编程

## 4.3.1 变量

shell变量分为两类：用户自定义变量和系统预定义的特殊变量。

### 4.3.1.1 用户自定义变量

1. 变量名
    用户自定义的变量是最普通的shell变量。变量名以字母或下划线开头，由字母、数字和下划线组成。注意数字不能做变量的开头符，大写字母通常是系统默认的变量，用户的自定义变量通常用小写字母。

2. 变量赋值
    变量命名后，需要赋值，未赋值的变量其值为空。变量赋值的一般形式为：变量名=字符串。注意，变量与变量内容以等号"="来连接，等号两遍不能有空格。如果出现空格，赋值语句执行失败，变量未被赋值，依然为空。如果字符串中一定包含空格，字符串要加上引号。例如：

    ```shell
    name="zhang san"
    ```

3. 变量引用
   在程序中使用变量的值时，需要在变量名前面加上"$"符，表示使用变量的值。例如：

    ```shell
    echo $name    
    ```

    在不加"$"符时，echo name会输出name。在下述情况下，变量的引用会出现歧义。

    ```shell
    dir=/home/student
    cat $dir01/file1
    ```

    在/home目录下，是以student开头，加学号的学生账户，所以上述命令的本意是要显示/home/student01/file1文件，但是shell无法区分变量名是dir还是dir01，在这种情况下，shell默认到第一个非法变量名字符为止，第一个非法变量名字符是/，所以shell认为变量名为dir01，而dir01未赋值，所以为空，命令执行失败。在这种情况下，要正确引用变量，需要用大括号将该变量名括起来，如下所示：

    ```shell
    cat ${dir}01/file1
    ```

    需要注意的是，大括号不要写成小括号，$( )等价于倒引号，其作用是吧括号内的执行结果赋值给变量，如：

    ```shell
    dir=$(pwd)
    ```

    是将当前工作的绝对路径赋给dir。<br>
    数组的定义和使用与变量类似。所谓数组就是相同数据类型的元素按一定顺序排列组合，也就是把有限个类型相同的变量用一个名字命名，然后用编号区分它们的变量集合，把这个名字称为数组名，把编号称为下标。组成数组的各个变量被称为数组的分量，又称为数组的元素、下表变量。但是
    bash仅支持一维数组（不支持多维数组），并且没有限定数组的大小。
    在bash中，用括号来表示数组，数组元素用"空格"符号分隔。定义数组的一般形式为：

    ```shell
    array name=(value1 ... valuen)
    ```

    例如：

    ```shell
    array city=(beijing shanghai tianjin guangzhou)
    ```

    也可以单独定义数组的各个分量

    ```shell
    array city[0]=beijing
    array city[1]=shanghai
    array city[2]=tianjin
    ```

    可以不使用连续的下标，而且下表的范围没有限制，还可以用declare命令显示声明一个数组而不赋值，其形式是declare -a city。这时city就是一个数组名，而不会被解释为一个变量了。
    读取数组的格式为"${数组名[下标]}"，即echo ${city[0]}。需要注意的是如果没有给出数组元素的下标，则数组名表示下标为0的数组元素，即echo $city等价于echo ${city[0]},所以要读取整个数组需要使用 * 或者 @ 作为下标。${city[*]}和${city[@]}的区别就是，前者将整个数组扩展为一个词（即字符串），这个词由以空格分开的各个数组元素组成；后者将整个数组扩展为多个词，每个数组元素是一个词。

### 4.3.1.2 系统预定义变量

|预定义变量|作用|
|:---:|:---:|
|$?|上一条命令执行后的返回值（也称返回码，退出状态等）|
|$$|当前进程的进程号（PID）|
|$!|上一个后台命令对应的进程号（PID）|
|$-|当前在运行shell程序的选项|
|$#|命令行上参数的个数|
|\$*,\$@|命令行上实际给出的所有实参|

"&?"是一个十进制数，大多数的shell命令执行成功后返回值为0；执行失败则返回非0值。

### 4.3.1.3 位置参数变量

在Linux的命令行中，当一条命令或脚本执行时，后面可以跟多个参数，使用位置参数变量来表示这些参数。其中，\$0代表命令行本身，\$1代表第一个参数,\$2代表第二个参数，依次类推。当参数个数超过10个时，就要用大括号把这个数字括起来，例如，${10}代表第10个参数，${14}代表第14个参数。

|位置参数变量|作用|
|:---:|:---:|
|$n|n为数字|
|$*|代表命令行中所有的参数，把所有的参数看成一个整体|
|$@|代表命令行中所有的参数，把每个参数区别对待|
|$#|命令行上参数的个数|

### 4.3.1.4 环境变量

环境变量也是系统预定义变量，环境变量和用户自定义变量还有一个主要区别就是，环境变量是全局变量，用户自定义变量为局部变量。
在bash中可以用env命令列出已定义的所有环境变量，下面举例说明主要环境变量的使用。

HOME：用户家目录的绝对路径。家目录是用户在开始工作时的位置。
PATH：shell查找命令的目录列表。
PS1：shell的主提示符。主提示符书在shell准备接受命令时显示的字符串。
PWD：当前工作目录的绝对路径，它指出目录在shell文件系统中处在什么位置。

### 4.3.1.5 变量的查询和删除

用户可以定义变量，在不需要的时候也可以注销该变量，注销变量用unset命令，其一般形式是：

```shell
unset 变量名
```

环境变量的删除方法和用户自定义变量是一样的，都使用unset命令。在注销变量之前，通常需要查询当前已有的变量列表，查询所有变量的命令有set，env和export。set的用法如下，env和export用法与set类似

```shell
set
```

三者的区别就是，set可以查询所有的变量，包括局部变量和全局变量，env命令可以查询所有的环境变量，包括本进程及“祖先进程”所设置的全局（环境）变量；export命令可以显示本进程利用export命令所输出的全部变量。

## 4.3.2 数值运算

1. 使用declare声明变量类型

    ```shell
    declare [选项] 变量名
    ```

    选项：
    \-:给变量设定类型属性
    \+:取消变量的类型属性
    \-a:将变量声明为数组型
    \-r:将变量声明为只读变量
    \-x:将变量声明为环境变量
    \-p:显示指定变量被声明的类<br>
    一旦变量被设置为只读类型，那么既不能修改该变量的值，也不能删除该变量，甚至不能用+r选项取消只读属性。只有结束该shell，重新登录或重启，这个变量才会消失。

2. 使用expr和let命令
    进行数值运算的第二种方法是使用expr命令，

    ```shell
    aa=11
    bb=22
    dd=$(expr $aa + $bb)
    ```

    let和expr类似，如下：

    ```shell
    aa=11
    bb=22
    let ee=$aa+$bb
    ```

3. 使用“\$((算术表达式))”运算
    凡是用let命令的地方都可以用((算术表达式))取代，但其中只能包含一个算术表达式，且只有使用\$((算术表达式))形式，才能返回表达式得值。

## 4.3.3 控制结构

### 4.3.3.1 if语句

if语句用于条件控制结构，其一般格式为：

```shell
if 测试条件
    then 命令1
    else 命令2
fi
```

其中，if、then、else和fi是关键字，例如：

```shell
if test -f "$1"
    then echo "$1 is an ordinary file"
    else echo "$1 is not an ordinary file"
fi
```

条件测试有两种常用形式：一种是用test命令，如上例所示；另一种是用一对方括号将测试条件括起来。这两种形式是完全等价的。
test condition <=> [ condition ]
在格式上需要注意的是，[ ]两端要有空格。

条件测试常用来测试文件的属性、做字符串的比较和数值的比较。
有关文件测试运算符的形式及其功能见下表：

|参数|作用|
|:---:|:---:|
|-r|若文件存在且用户可读，则测试条件为真|
|-w|若文件存在且用户可写，则测试条件为真|
|-x|若文件存在且用户可执行，则测试条件为真|
|-f|若文件存在且是普通文件，则测试条件为真|
|-d|若文件存在且是目录文件，则测试条件为真|
|-b|若文件存在且是块设备文件，则测试条件为真|
|-c|若文件存在且是字符设备文件，则测试条件为真|
|-s|若文件存在且文件长度大于0，则测试条件为真|
|-e|该文件是否存在|
<br>

有关字符串测试运算符的形式及其功能见下表：
|参数|作用|
|:---:|:---:|
|-z s1|若字符串s1的长度为0，则测试条件为真|
|-n s1|若字符串s1的长度大于0，则测试条件为真|
|s1 = s2|若s1等于s2，则测试条件为真，“=”前后应有空格|
|s1 ! = s2|若s1不等于s2，则测试条件为真|

[ ]内每个组件都需要用空格分开；在字符串s1,s2比较时最好都用双引号“ ”括起来。
<br>
有关数值测试运算符的形式及其功能见下表:
|参数|作用|
|:--:|:--:|
|n1 -eq n2|若n1等于n2，则测试结果为真|
|n1 -ne n2|若n1不等于n2，则测试结果为真|
|n1 -lt n2|若n1小于n2，则测试结果为真|
|n1 -le n2|若n1小于或等于n2，则测试结果为真|
|n1 -gt n2|若n1大于n2，则测试结果为真|
|n1 -ge n2|若n1大于或等于n2，则测试结果为真|
<br>

else部分还可以嵌套if，用关键字elif代替else if，其一般格式如下：

```shell
if [条件判断式1]
    then 命令1
    elif [条件判断式2]
    then 命令2
    else 命令3
fi
```

### 4.3.3.2 case语句

case语句和if语句一样都是多分支条件语句，不过和多分支if条件语句不同的是，case语句只能判断一种条件关系，而if语句可以判断多种条件关系。
case语句的语法如下：

```shell
case $变量名 in
    "值一"） 命令
            命令;;
    "值二"） 命令
            命令;;
    省略其他分支
    *） 命令
        命令;;
esac
```

### 4.3.3.3 while语句

```shell
while condition
    do
        statements
    done
```

### 4.3.3.4 until语句

```shell
until condition
    do
        statements
    done
```

### 4.3.3.5 for语句

```shell
for((exp1;exp2;exp3))
do
    statements
done
```

```shell
for variable in value_list
do
    statements
done
```

### 4.3.3.6 select in 语句

select in shell独有的一种循环，非常适合终端这样的交互场景。

```shell
select variable in value_list
do
    statemments
done
```

select是无限循环，只有遇到break语句或者按下Ctrl+D组合键才能结束循环。

### 4.3.3.7 break 和 continue 关键字

shell中的 break 和 continue 能够跳过多层循环，也就是说，内层循环中的 break 和 continue 能够跳出外层循环。

1. break 关键字
    break关键字的用法为:
    break n;
    n为跳出循环的层数，如果省略n,则表示跳出整个循环

2. continue 关键字
    continue关键字的用法为:
    continue n
    n 表示循环的层数，如果省略 n，则表示 continue 只对当前层次的循环语句有效。

## 4.4 shell 函数

### 4.4.1 函数定义

shell函数定义的语法格式如下:

```shell
function name()
{
    statements
    [return value]
}
```

也可以不写function关键字，如下:

```shell
function name()
{
    statements
    [return value]
}
```

如果写了function关键字，也可以省略函数名后面的小括号，如下:

```shell
function name
{
    statements
    [return value]
}
```

调用shell函数时可以给他传递参数，也可以不传递。如果不传递参数，直接给出函数名字即可；如果传递参数，那么多个参数之间以空格分隔。